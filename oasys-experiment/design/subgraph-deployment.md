# サブグラフデプロイメント手順

## 環境セットアップ

### プラットフォーム互換性
- M1/M2 Mac (arm64)での実行時は、`platform: linux/amd64`の指定が必要
- Rosetta 2による互換性変換を利用
- パフォーマンスへの影響は最小限

## デプロイメント手順

1. 環境の起動
```bash
docker compose up -d
```

2. サブグラフのセットアップとデプロイ
```bash
# 依存関係のインストール
cd subgraph
yarn

# コード生成とビルド
yarn codegen
yarn build

# ローカルサブグラフの作成
yarn create-local

# サブグラフのデプロイ（バージョンラベルを指定）
echo "v0.0.1" | yarn deploy-local
```

## バージョン管理

### バージョニング規則
- セマンティックバージョニング（vX.Y.Z）を採用
- X: メジャーバージョン（互換性のない変更）
- Y: マイナーバージョン（後方互換性のある機能追加）
- Z: パッチバージョン（バグ修正）

### バージョン履歴
- v0.0.1: 初期実装（基本的なイベント追跡）
- v0.0.2: chain name追加（L2の名前を保存）

## 動作確認

### エンドポイント
- GraphQL: http://localhost:8000/subgraphs/name/oasys/bridge/graphql
- WebSocket: ws://localhost:8001/ws
- Admin: http://localhost:8020

### ヘルスチェック項目
- [x] Graph Nodeの起動状態
- [x] IPFSの接続
- [x] PostgreSQLの接続
- [x] ブロック同期の進行
- [x] イベント処理の状態

### データ検証
1. イベントの取得
```graphql
{
  bridgeEvents(first: 5) {
    id
    verseId
    chainName
    eventType
    amount
    timestamp
  }
}
```

2. 日次統計の確認
```graphql
{
  dailyBridgeStats(first: 5) {
    id
    date
    verseId
    chainName
    eventType
    total_amount
    count
  }
}
```

## トラブルシューティング

### OOMKiller対策
1. メモリ使用量の監視
2. 必要に応じてメモリ制限の調整
3. スワップ領域の確保

### プラットフォーム互換性の問題
1. Docker Composeファイルでのプラットフォーム指定
2. イメージのプル時にプラットフォームを確認
3. ログの確認でエラーの特定

### ブロック同期の問題
1. ログの確認
2. ネットワーク接続の確認
3. RPC エンドポイントの状態確認

## 開発時のバージョン管理

### 固定バージョンの使用
- 開発環境では、同じバージョン番号（例：v0.0.2）を継続して使用可能
- ただし、以下の点に注意が必要：
  1. 同じバージョン番号での再デプロイは、同期状態が完全にリセットされる
  2. ブロックの同期が最初から再開される
  3. 大量のブロックがある場合、同期完了までに時間がかかる

### 推奨プラクティス
1. スキーマやマッピングの変更テスト時：
   - 同じバージョン番号を使用して素早くイテレーション
   - 同期状態のリセットを許容

2. 本番環境への移行時：
   - セマンティックバージョニングに従って新しいバージョン番号を採用
   - 同期状態を維持するため、バージョンを単調増加

### 開発フロー
1. 開発時は`v0.0.2`などの固定バージョンを使用
2. 変更のテストと確認
3. 確定した変更を本番環境用にバージョンアップ

最終更新: 2024年1月17日 